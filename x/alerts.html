<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>AgriSmart — Alerts</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="insertHeader"></div>
  <main class="container">
    <div class="card">
      <h2>Alerts & Notifications</h2>
      <p class="muted">Stay informed about pests, weather, price and resource alerts</p>
    </div>

    <section style="display:grid;grid-template-columns:2fr 1fr;gap:12px;margin-top:12px">
      <div class="card" id="alertsList"></div>
      <aside class="card">
        <h3>Alert Settings</h3>
        <div style="display:flex;flex-direction:column;gap:10px;margin-top:12px">
          <label><input type="checkbox" id="pestToggle" checked> Pest alerts</label>
          <label><input type="checkbox" id="weatherToggle" checked> Weather alerts</label>
          <label><input type="checkbox" id="priceToggle" checked> Price alerts</label>
        </div>
      </aside>
    </section>
  </main>

  <script src="app.js"></script>
  <script>
    try { ensureAuth() } catch(e) { console.error('Auth failed:', e); location.href='auth.html' }
    
    let localDemo = {}
    try {
      localDemo = JSON.parse(localStorage.getItem('agri_demo')||'{}')
    } catch(e) {
      console.error('Error parsing demo data:', e)
      localDemo = {}
    }
    
    function renderAlerts(){
      try {
        const container = document.getElementById('alertsList')
        if(!container) return
        container.innerHTML = ''
        
        const alerts = localDemo.alerts || []
        if(alerts.length === 0) {
          container.innerHTML = '<div class="muted">No alerts at this time</div>'
          return
        }
        
        alerts.forEach(a=>{
          try {
            if(!a || !a.id) return
            const el = document.createElement('div')
            el.className='card'
            el.style.marginBottom='10px'
            
            const severity = a.sev || 'med'
            const severityColor = severity==='high'?'#d9534f':severity==='med'?'#f0ad4e':'#5cb85c'
            
            el.innerHTML = `<div style="display:flex;align-items:flex-start;gap:12px">
              <div style="font-size:20px">⚠️</div>
              <div style="flex:1">
                <div style="font-weight:700">${a.title || 'Alert'} <span class="muted" style="font-weight:600;margin-left:8px;color:${severityColor}">${severity}</span></div>
                <div class="muted">${a.text || 'No description'}</div>
                <div class="muted" style="margin-top:8px">${new Date(a.ts || Date.now()).toLocaleString()}</div>
              </div>
              <div><button class="btn" onclick="dismiss(${a.id})">Dismiss</button></div>
            </div>`
            container.appendChild(el)
          } catch(e) {
            console.error('Error rendering alert:', a, e)
          }
        })
      } catch(e) {
        console.error('Render alerts error:', e)
      }
    }
    
    renderAlerts()
    
    function dismiss(id){
      try {
        if(!id) return
        const a = localDemo.alerts || []
        localDemo.alerts = a.filter(x=>x.id!==id)
        localStorage.setItem('agri_demo', JSON.stringify(localDemo))
        renderAlerts()
        toast('Alert dismissed')
      } catch(e) {
        console.error('Dismiss error:', e)
        toast('Failed to dismiss alert', 3000)
      }
    }
    
    // Alert settings handlers
    try {
      const pestToggle = document.getElementById('pestToggle')
      const weatherToggle = document.getElementById('weatherToggle')
      const priceToggle = document.getElementById('priceToggle')
      
      if(pestToggle) pestToggle.addEventListener('change', () => {
        try {
          localStorage.setItem('pestAlerts', pestToggle.checked)
          toast('Pest alerts ' + (pestToggle.checked ? 'enabled' : 'disabled'))
        } catch(e) { console.error('Error:', e) }
      })
      
      if(weatherToggle) weatherToggle.addEventListener('change', () => {
        try {
          localStorage.setItem('weatherAlerts', weatherToggle.checked)
          toast('Weather alerts ' + (weatherToggle.checked ? 'enabled' : 'disabled'))
        } catch(e) { console.error('Error:', e) }
      })
      
      if(priceToggle) priceToggle.addEventListener('change', () => {
        try {
          localStorage.setItem('priceAlerts', priceToggle.checked)
          toast('Price alerts ' + (priceToggle.checked ? 'enabled' : 'disabled'))
        } catch(e) { console.error('Error:', e) }
      })
    } catch(e) {
      console.error('Settings init error:', e)
    }
  </script>
</body>
</html>
