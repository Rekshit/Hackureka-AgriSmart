<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>AgriSmart — Profile</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="insertHeader"></div>
  <main class="container">
    <div class="card" id="profileCard">
      <h2>Profile</h2>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div>
          <label>Full name</label>
          <input id="profileName">
        </div>
        <div>
          <label>Email</label>
          <input id="profileEmail" disabled>
        </div>
        <div>
          <label>Location</label>
          <input id="profileLocation">
        </div>
        <div>
          <label>Farm size</label>
          <input id="profileSize">
        </div>
      </div>
      <div style="margin-top:12px">
        <button class="btn primary" onclick="saveProfile()">Save Changes</button>
        <button class="btn" onclick="signOut()">Logout</button>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>Saved Predictions</h3>
      <div id="savedPred"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>Booking History</h3>
      <div id="bookingHist"></div>
    </div>
  </main>

  <script src="app.js"></script>
  <script>
    try {
      const curr = ensureAuth()
      document.getElementById('profileName').value = curr.name || ''
      document.getElementById('profileEmail').value = curr.email || ''
      document.getElementById('profileLocation').value = curr.profile?.farm || ''
      document.getElementById('profileSize').value = curr.profile?.size || ''
    } catch(e) {
      console.error('Profile init error:', e)
      location.href='auth.html'
    }

    function saveProfile(){
      try {
        const name = document.getElementById('profileName').value.trim()
        const location = document.getElementById('profileLocation').value.trim()
        const size = document.getElementById('profileSize').value.trim()
        
        if(!name) { toast('Name is required', 3000); return }
        if(name.length < 3) { toast('Name must be at least 3 characters', 3000); return }
        
        const users = getUsers()
        const u = users.find(x=>x.email===curr.email)
        if(!u) { toast('User not found', 3000); return }
        
        u.name = name
        u.profile = {farm: location, size: size}
        saveUsers(users)
        toast('Profile updated')
        location.reload()
      } catch(e) {
        console.error('Save profile error:', e)
        toast('Failed to save profile', 3000)
      }
    }

    // saved predictions
    try {
      const sp = JSON.parse(localStorage.getItem('savedPredictions')||'[]')
      document.getElementById('savedPred').innerHTML = sp.length ? sp.map(s=>`<div style="padding:8px 0"><strong>${s.crop || 'Unknown'}</strong> — ${s.date || 'N/A'}</div>`).join('') : '<div class="muted">No saved predictions</div>'
    } catch(e) {
      console.error('Error loading predictions:', e)
      document.getElementById('savedPred').innerHTML = '<div class="muted">Error loading predictions</div>'
    }

    // bookings
    try {
      const bookings = JSON.parse(localStorage.getItem('bookings')||'[]')
      document.getElementById('bookingHist').innerHTML = bookings.length ? bookings.map(b=>`<div style="padding:8px 0"><strong>${b.item || 'Unknown'}</strong> • ${b.dates || 'N/A'} • <span style="background:#efefef;padding:6px;border-radius:8px">${b.cost ? '₹'+b.cost : '—'}</span></div>`).join('') : '<div class="muted">No bookings</div>'
    } catch(e) {
      console.error('Error loading bookings:', e)
      document.getElementById('bookingHist').innerHTML = '<div class="muted">Error loading bookings</div>'
    }
  </script>
</body>
</html>
